name: Integration Tests

on:
  schedule:
    # Run integration tests daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      api_url:
        description: 'API URL to test against'
        required: false
        default: 'https://key-value.co'
  push:
    branches: [ main ]
    paths:
      - 'python/**'
      - 'javascript/**'
      - 'go/**'
      - 'rust/**'

jobs:
  integration-python:
    name: Python Integration Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' || github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v5

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'

    - name: Install dependencies
      working-directory: ./python
      run: |
        pip install -e .
        pip install pytest requests

    - name: Run integration tests
      working-directory: ./python
      env:
        KV_API_URL: ${{ github.event.inputs.api_url || 'https://key-value.co' }}
        KV_TEST_TOKEN: ${{ secrets.KV_TEST_TOKEN }}
      run: |
        pytest tests/ -v -m integration || echo "Integration tests require KV_TEST_TOKEN secret"

    - name: Test live API (generate token)
      env:
        KV_API_URL: ${{ github.event.inputs.api_url || 'https://key-value.co' }}
      run: |
        python -c "
        from keyvalue import KeyValueClient
        import os
        client = KeyValueClient(base_url=os.getenv('KV_API_URL', 'https://key-value.co'))
        try:
            result = client.generate()
            print(f'‚úì Generated token: {result[\"token\"][:20]}...')
            # Test basic store/retrieve
            client.set_token(result['token'])
            client.store({'test': 'integration', 'timestamp': '$(date +%s)'})
            data = client.retrieve()
            assert data['data']['test'] == 'integration'
            print('‚úì Store/retrieve works')
            # Cleanup
            client.delete()
            print('‚úì Delete works')
            print('‚úÖ All integration checks passed!')
        except Exception as e:
            print(f'‚ö†Ô∏è  Integration test failed: {e}')
            exit(1)
        "

  integration-javascript:
    name: JavaScript Integration Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' || github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v5

    - name: Set up Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20'

    - name: Install dependencies
      working-directory: ./javascript
      run: npm ci

    - name: Run integration tests
      working-directory: ./javascript
      env:
        KV_API_URL: ${{ github.event.inputs.api_url || 'https://key-value.co' }}
        KV_TEST_TOKEN: ${{ secrets.KV_TEST_TOKEN }}
      run: npm test -- --run || echo "Integration tests require KV_TEST_TOKEN secret"

    - name: Test live API (generate token)
      working-directory: ./javascript
      env:
        KV_API_URL: ${{ github.event.inputs.api_url || 'https://key-value.co' }}
      run: |
        node -e "
        const { KeyValueClient } = require('./dist/index.js');
        (async () => {
          const client = new KeyValueClient({ 
            baseUrl: process.env.KV_API_URL || 'https://key-value.co' 
          });
          try {
            const result = await client.generate();
            console.log(\`‚úì Generated token: \${result.token.slice(0, 20)}...\`);
            client.setToken(result.token);
            await client.store({ test: 'integration', timestamp: Date.now() });
            const data = await client.retrieve();
            if (data.data.test !== 'integration') throw new Error('Data mismatch');
            console.log('‚úì Store/retrieve works');
            await client.delete();
            console.log('‚úì Delete works');
            console.log('‚úÖ All integration checks passed!');
          } catch (e) {
            console.error(\`‚ö†Ô∏è  Integration test failed: \${e.message}\`);
            process.exit(1);
          }
        })();
        "

  integration-go:
    name: Go Integration Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' || github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v5

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'

    - name: Download dependencies
      working-directory: ./go
      run: go mod download

    - name: Run integration tests
      working-directory: ./go
      env:
        KV_API_URL: ${{ github.event.inputs.api_url || 'https://key-value.co' }}
        KV_TEST_TOKEN: ${{ secrets.KV_TEST_TOKEN }}
      run: go test -v -tags=integration ./... || echo "Integration tests require KV_TEST_TOKEN secret"

  integration-summary:
    name: Integration Test Summary
    runs-on: ubuntu-latest
    needs: [integration-python, integration-javascript, integration-go]
    if: always()

    steps:
    - name: Check integration results
      run: |
        echo "üìä Integration Test Results:"
        echo "  Python: ${{ needs.integration-python.result }}"
        echo "  JavaScript: ${{ needs.integration-javascript.result }}"
        echo "  Go: ${{ needs.integration-go.result }}"
        
        if [[ "${{ needs.integration-python.result }}" == "failure" ]] || \
           [[ "${{ needs.integration-javascript.result }}" == "failure" ]] || \
           [[ "${{ needs.integration-go.result }}" == "failure" ]]; then
          echo "‚ùå Some integration tests failed"
          exit 1
        fi
        
        echo "‚úÖ All integration tests passed!"

    - name: Create issue on failure
      if: failure() && github.event_name == 'schedule'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: '‚ö†Ô∏è  Scheduled integration tests failed',
            body: `Integration tests failed on scheduled run.\n\nWorkflow: ${context.workflow}\nRun: ${context.runId}\n\nPlease investigate: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
            labels: ['bug', 'integration-test', 'automated']
          })
